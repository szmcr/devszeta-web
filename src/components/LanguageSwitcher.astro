---
import { languages, type Language } from "../i18n";

interface Props {
  currentLang: Language;
}

const { currentLang } = Astro.props;
const pathname = Astro.url.pathname;

function getLanguagePath(lang: Language): string {
  // Remove trailing slash for consistent handling
  const cleanPathname = pathname.endsWith('/') && pathname !== '/' 
    ? pathname.slice(0, -1) 
    : pathname;
  
  // Handle project pages
  if (cleanPathname.includes("/projects/") || cleanPathname.includes("/proyectos/")) {
    const parts = cleanPathname.split("/").filter(p => p);
    const projectId = parts[parts.length - 1];
    
    if (lang === "en") {
      return `/en/projects/${projectId}`;
    }
    return `/proyectos/${projectId}`;
  }
  
  // Handle home pages
  if (cleanPathname === "/" || cleanPathname === "/en") {
    return lang === "en" ? "/en" : "/";
  }
  
  // Handle other pages - remove language prefix and add new one
  let cleanPath = cleanPathname.replace(/^\/(en)/, "") || "/";
  
  if (lang === "es") {
    return cleanPath;
  }
  return `/en${cleanPath === "/" ? "" : cleanPath}`;
}
---

<div class="relative">
  <button
    id="lang-toggle"
    class="flex items-center gap-2 px-3 py-2 bg-white/10 hover:bg-white/20 rounded-lg transition-colors text-sm font-medium cursor-pointer"
    aria-label="Cambiar idioma"
  >
    <span class="uppercase">{currentLang}</span>
    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
    </svg>
  </button>

  <div
    id="lang-dropdown"
    class="hidden absolute right-0 mt-2 py-2 w-32 bg-primary-dark border border-white/10 rounded-lg shadow-xl z-50"
  >
    {Object.entries(languages).map(([lang, label]) => (
      <a
        href={getLanguagePath(lang as Language)}
        class={`block px-4 py-2 text-sm hover:bg-white/10 transition-colors ${
          lang === currentLang ? "text-accent" : "text-white/80"
        }`}
      >
        {label}
      </a>
    ))}
  </div>
</div>

<script>
  function initLanguageSwitcher() {
    const toggle = document.getElementById("lang-toggle");
    const dropdown = document.getElementById("lang-dropdown");

    if (!toggle || !dropdown) return;

    // Remove existing listeners by cloning and replacing
    const newToggle = toggle.cloneNode(true) as HTMLElement;
    toggle.parentNode?.replaceChild(newToggle, toggle);

    // Add click listener to toggle
    newToggle.addEventListener("click", (e) => {
      e.stopPropagation();
      dropdown.classList.toggle("hidden");
    });

    // Close dropdown when clicking outside
    const closeDropdown = (e: MouseEvent) => {
      if (!newToggle.contains(e.target as Node) && !dropdown.contains(e.target as Node)) {
        dropdown.classList.add("hidden");
      }
    };

    document.addEventListener("click", closeDropdown);
  }

  // Initialize on page load
  document.addEventListener("DOMContentLoaded", initLanguageSwitcher);
  
  // Re-initialize on Astro page transitions
  document.addEventListener("astro:page-load", initLanguageSwitcher);
</script>
