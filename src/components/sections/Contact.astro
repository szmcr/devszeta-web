---
import SectionTitle from "../ui/SectionTitle.astro";
import Button from "../ui/Button.astro";
import { useTranslations, type Language } from "../../i18n";

interface Props {
  lang: Language;
}

const { lang } = Astro.props;
const t = useTranslations(lang);

const contactInfo = [
  {
    id: "email",
    label: t("contact.info.email"),
    value: "info@devszeta.com",
    href: "mailto:info@devszeta.com",
  },
  {
    id: "phone",
    label: t("contact.info.phone"),
    value: "+506 7278-8228",
    href: "tel:+50672788228",
  },
  {
    id: "location",
    label: t("contact.info.location"),
    value: "San Jos√©, Costa Rica",
    href: "#",
  },
  {
    id: "github",
    label: "GitHub",
    value: "github.com/devszeta",
    href: "https://github.com/szmcr",
  },
];

const icons: Record<string, string> = {
  email: `<svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
    <path stroke-linecap="round" stroke-linejoin="round" d="M21.75 6.75v10.5a2.25 2.25 0 01-2.25 2.25h-15a2.25 2.25 0 01-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0019.5 4.5h-15a2.25 2.25 0 00-2.25 2.25m19.5 0v.243a2.25 2.25 0 01-1.07 1.916l-7.5 4.615a2.25 2.25 0 01-2.36 0L3.32 8.91a2.25 2.25 0 01-1.07-1.916V6.75" />
  </svg>`,
  phone: `<svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
    <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 6.75c0 8.284 6.716 15 15 15h2.25a2.25 2.25 0 002.25-2.25v-1.372c0-.516-.351-.966-.852-1.091l-4.423-1.106c-.44-.11-.902.055-1.173.417l-.97 1.293c-.282.376-.769.542-1.21.38a12.035 12.035 0 01-7.143-7.143c-.162-.441.004-.928.38-1.21l1.293-.97c.363-.271.527-.734.417-1.173L6.963 3.102a1.125 1.125 0 00-1.091-.852H4.5A2.25 2.25 0 002.25 4.5v2.25z" />
  </svg>`,
  location: `<svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
    <path stroke-linecap="round" stroke-linejoin="round" d="M15 10.5a3 3 0 11-6 0 3 3 0 016 0z" />
    <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1115 0z" />
  </svg>`,
  github: `<svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
    <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
  </svg>`,
};
---

<section id="contacto" class="py-20 md:py-32 bg-white/[0.02]">
  <div class="container mx-auto px-4">
    <SectionTitle subtitle={t("contact.subtitle")}>
      {t("contact.title")}
    </SectionTitle>
    
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-12 max-w-6xl mx-auto">
      <!-- Contact Form -->
      <div class="bg-white/5 border border-white/10 rounded-2xl p-8">
        <h3 class="text-xl font-semibold text-white mb-6">{t("contact.form.title")}</h3>
        
        <form id="contact-form" class="space-y-6">
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
              <label for="name" class="block text-sm text-white/70 mb-2">{t("contact.form.name")}</label>
              <input 
                type="text" 
                id="name" 
                name="name"
                class="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-lg text-white placeholder-white/40 focus:border-accent focus:outline-none transition-colors"
                placeholder={t("contact.form.name.placeholder")}
                minlength="2"
                maxlength="100"
                required
              />
              <span class="error-message text-red-400 text-sm mt-1 hidden"></span>
            </div>
            <div>
              <label for="email" class="block text-sm text-white/70 mb-2">{t("contact.form.email")}</label>
              <input 
                type="email" 
                id="email" 
                name="email"
                class="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-lg text-white placeholder-white/40 focus:border-accent focus:outline-none transition-colors"
                placeholder={t("contact.form.email.placeholder")}
                maxlength="100"
                required
              />
              <span class="error-message text-red-400 text-sm mt-1 hidden"></span>
            </div>
          </div>
          
          <div>
            <label for="subject" class="block text-sm text-white/70 mb-2">{t("contact.form.subject")}</label>
            <input 
              type="text" 
              id="subject" 
              name="subject"
              class="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-lg text-white placeholder-white/40 focus:border-accent focus:outline-none transition-colors"
              placeholder={t("contact.form.subject.placeholder")}
              minlength="3"
              maxlength="200"
              required
            />
            <span class="error-message text-red-400 text-sm mt-1 hidden"></span>
          </div>
          
          <div>
            <label for="message" class="block text-sm text-white/70 mb-2">{t("contact.form.message")}</label>
            <textarea 
              id="message" 
              name="message"
              rows="5"
              class="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-lg text-white placeholder-white/40 focus:border-accent focus:outline-none transition-colors resize-none"
              placeholder={t("contact.form.message.placeholder")}
              minlength="10"
              maxlength="2000"
              required
            ></textarea>
            <span class="error-message text-red-400 text-sm mt-1 hidden"></span>
          </div>
          
          <!-- Honeypot field (hidden from users, bots will fill it) -->
          <input 
            type="text" 
            name="website" 
            class="hidden" 
            tabindex="-1" 
            autocomplete="off"
          />
          
          <!-- Timestamp for time-based validation -->
          <input 
            type="hidden" 
            name="timestamp" 
            id="form-timestamp"
          />
          
          <div id="form-message" class="hidden p-4 rounded-lg"></div>
          
          <button 
            type="submit" 
            id="submit-btn"
            class="w-full px-8 py-4 bg-accent hover:bg-accent/90 hover:cursor-pointer text-white font-medium rounded-lg transition-all duration-300 hover:shadow-lg hover:shadow-accent/50 disabled:opacity-50 disabled:cursor-not-allowed"
          >
            <span id="submit-text">{t("contact.form.submit")}</span>
            <span id="submit-loading" class="hidden">Enviando...</span>
          </button>
        </form>
      </div>
      
      <!-- Contact Info -->
      <div class="flex flex-col justify-center">
        <h3 class="text-xl font-semibold text-white mb-6">{t("contact.info.title")}</h3>
        
        <div class="space-y-5 mb-10">
          {contactInfo.map((info) => (
            <a 
              href={info.href}
              target={info.id === "github" || info.id === "linkedin" ? "_blank" : undefined}
              rel={info.id === "github" || info.id === "linkedin" ? "noopener noreferrer" : undefined}
              class="flex items-center gap-4 group"
            >
              <span 
                class="w-12 h-12 bg-accent/20 rounded-xl flex items-center justify-center text-white group-hover:bg-accent transition-colors"
                set:html={icons[info.id]}
              />
              <div>
                <p class="text-sm text-white/60">{info.label}</p>
                <p class="text-white font-medium group-hover:text-accent transition-colors">{info.value}</p>
              </div>
            </a>
          ))}
        </div>
        
        <div class="p-6 bg-gradient-to-r from-accent/20 to-purple-500/20 rounded-2xl border border-accent/30">
          <h4 class="font-semibold text-white mb-2">{t("contact.cta.title")}</h4>
          <p class="text-sm text-white/70">
            {t("contact.cta.description")}
          </p>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('contact-form') as HTMLFormElement;
    const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;
    const submitText = document.getElementById('submit-text') as HTMLSpanElement;
    const submitLoading = document.getElementById('submit-loading') as HTMLSpanElement;
    const formMessage = document.getElementById('form-message') as HTMLDivElement;
    const timestampInput = document.getElementById('form-timestamp') as HTMLInputElement;

    if (timestampInput) {
      timestampInput.value = Date.now().toString();
    }

    function showError(fieldName: string, message: string) {
      const field = form.querySelector(`[name="${fieldName}"]`) as HTMLInputElement | HTMLTextAreaElement;
      const errorSpan = field?.parentElement?.querySelector('.error-message') as HTMLSpanElement;
      
      if (field && errorSpan) {
        field.classList.add('border-red-400');
        errorSpan.textContent = message;
        errorSpan.classList.remove('hidden');
      }
    }

    function clearErrors() {
      const errorMessages = form.querySelectorAll('.error-message');
      const fields = form.querySelectorAll('input, textarea');
      
      errorMessages.forEach(error => {
        error.classList.add('hidden');
        error.textContent = '';
      });
      
      fields.forEach(field => {
        field.classList.remove('border-red-400');
      });
    }

    function showFormMessage(message: string, isError: boolean = false) {
      formMessage.textContent = message;
      formMessage.classList.remove('hidden', 'bg-green-500/20', 'border-green-500', 'text-green-400', 'bg-red-500/20', 'border-red-500', 'text-red-400');
      
      if (isError) {
        formMessage.classList.add('bg-red-500/20', 'border', 'border-red-500', 'text-red-400');
      } else {
        formMessage.classList.add('bg-green-500/20', 'border', 'border-green-500', 'text-green-400');
      }
    }

    function setLoading(loading: boolean) {
      submitBtn.disabled = loading;
      
      if (loading) {
        submitText.classList.add('hidden');
        submitLoading.classList.remove('hidden');
      } else {
        submitText.classList.remove('hidden');
        submitLoading.classList.add('hidden');
      }
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      clearErrors();
      formMessage.classList.add('hidden');
      setLoading(true);

      const formData = new FormData(form);
      
      try {
        const response = await fetch('/api/contact', {
          method: 'POST',
          body: formData,
        });

        const data = await response.json();

        if (response.ok && data.success) {
          showFormMessage(data.message, false);
          form.reset();
          
          if (timestampInput) {
            timestampInput.value = Date.now().toString();
          }
        } else {
          if (data.errors && Array.isArray(data.errors)) {
            data.errors.forEach((error: { field: string; message: string }) => {
              showError(error.field, error.message);
            });
          }
          
          if (data.error) {
            showFormMessage(data.error, true);
          }
        }
      } catch (error) {
        console.error('Error submitting form:', error);
        showFormMessage('Error al enviar el formulario. Por favor intenta de nuevo.', true);
      } finally {
        setLoading(false);
      }
    });

    const inputs = form.querySelectorAll('input, textarea');
    inputs.forEach(input => {
      input.addEventListener('input', () => {
        const errorSpan = input.parentElement?.querySelector('.error-message') as HTMLSpanElement;
        if (errorSpan && !errorSpan.classList.contains('hidden')) {
          input.classList.remove('border-red-400');
          errorSpan.classList.add('hidden');
        }
      });
    });
  });
</script>
